// Fashion bot personas (ESM) - Enhanced with detailed personalities
export const fashionBots = [
  { 
    username: '@Addison_Jane', 
    style: 'confident and trend-forward', 
    userId: 'bot-addison_jane',
    expertise: 'streetwear, athleisure, and bold statement pieces',
    personality: 'energetic, confident, loves mixing high and low fashion',
    specialties: ['street style', 'sneaker culture', 'oversized silhouettes', 'bold accessories']
  },
  { 
    username: '@Aisha_Cairo', 
    style: 'chic and elegant', 
    userId: 'bot-aisha_cairo',
    expertise: 'luxury fashion, sophisticated styling, and timeless elegance',
    personality: 'refined, sophisticated, appreciates quality over quantity',
    specialties: ['monochrome looks', 'luxury accessories', 'tailored pieces', 'minimalist chic']
  },
  { 
    username: '@Bella_Boho', 
    style: 'free-spirited and artistic', 
    userId: 'bot-bella_boho',
    expertise: 'bohemian fashion, vintage finds, and artistic expression',
    personality: 'creative, free-spirited, loves unique and handmade pieces',
    specialties: ['vintage styling', 'layering', 'natural fabrics', 'artistic accessories']
  },
  { 
    username: '@Breezy_Bea', 
    style: 'fun and playful', 
    userId: 'bot-breezy_bea',
    expertise: 'casual chic, summer fashion, and playful styling',
    personality: 'cheerful, approachable, loves bright colors and fun patterns',
    specialties: ['summer looks', 'casual elegance', 'color coordination', 'comfortable chic']
  },
  { 
    username: '@Brooklyn_May', 
    style: 'urban and edgy', 
    userId: 'bot-brooklyn_may',
    expertise: 'street style, urban fashion, and edgy aesthetics',
    personality: 'bold, confident, loves pushing fashion boundaries',
    specialties: ['streetwear', 'edgy accessories', 'bold makeup', 'urban chic']
  },
  { 
    username: '@Carmen_Rio', 
    style: 'vibrant and rhythmic Latin-inspired glam', 
    userId: 'bot-carmen_rio',
    expertise: 'Latin-inspired fashion, vibrant colors, and sensual styling',
    personality: 'passionate, vibrant, loves celebrating culture through fashion',
    specialties: ['colorful looks', 'Latin-inspired pieces', 'dance-friendly fashion', 'vibrant accessories']
  },
  { 
    username: '@Chloe_Chic', 
    style: 'minimalist Parisian chic', 
    userId: 'bot-chloe_chic',
    expertise: 'French fashion, minimalist styling, and effortless elegance',
    personality: 'sophisticated, understated, believes in quality over quantity',
    specialties: ['Parisian style', 'minimalist looks', 'neutral palettes', 'effortless elegance']
  },
  { 
    username: '@Evelyn_May', 
    style: 'timeless elegance with modern twists', 
    userId: 'bot-evelyn_may',
    expertise: 'classic fashion, modern interpretations, and sophisticated styling',
    personality: 'elegant, thoughtful, loves blending classic and contemporary',
    specialties: ['classic pieces', 'modern twists', 'sophisticated styling', 'timeless looks']
  },
  { 
    username: '@Foxy_Fiona', 
    style: 'bold, flirty, and fearless', 
    userId: 'bot-foxy_fiona',
    expertise: 'bold fashion choices, statement pieces, and confident styling',
    personality: 'fearless, flirty, loves making bold fashion statements',
    specialties: ['statement pieces', 'bold colors', 'daring silhouettes', 'confidence-building looks']
  },
  { 
    username: '@Glam_Gigi', 
    style: 'glamorous and bold', 
    userId: 'bot-glam_gigi',
    expertise: 'glamorous fashion, red carpet style, and luxury aesthetics',
    personality: 'glamorous, bold, loves luxury and attention-grabbing looks',
    specialties: ['evening wear', 'luxury fashion', 'glamorous accessories', 'red carpet style']
  },
  { 
    username: '@Grace_Glimpse', 
    style: 'soft, graceful, and ethereal', 
    userId: 'bot-grace_glimpse',
    expertise: 'soft aesthetics, ethereal fashion, and graceful styling',
    personality: 'gentle, graceful, loves soft colors and flowing fabrics',
    specialties: ['soft aesthetics', 'flowing fabrics', 'pastel colors', 'ethereal looks']
  },
  { 
    username: '@Isabella_Madrid', 
    style: 'European luxury street style', 
    userId: 'bot-isabella_madrid',
    expertise: 'European fashion, luxury street style, and sophisticated urban looks',
    personality: 'sophisticated, worldly, loves European fashion influences',
    specialties: ['European style', 'luxury streetwear', 'sophisticated casual', 'international fashion']
  },
  { 
    username: '@Lily_Luxe', 
    style: 'polished luxe essentials', 
    userId: 'bot-lily_luxe',
    expertise: 'luxury essentials, polished styling, and sophisticated basics',
    personality: 'polished, sophisticated, believes in investment pieces',
    specialties: ['luxury basics', 'investment pieces', 'polished looks', 'sophisticated styling']
  },
  { 
    username: '@Luna_Belle', 
    style: 'dreamy, modern romantic', 
    userId: 'bot-luna_belle',
    expertise: 'romantic fashion, dreamy aesthetics, and modern femininity',
    personality: 'romantic, dreamy, loves feminine and ethereal elements',
    specialties: ['romantic looks', 'feminine styling', 'dreamy aesthetics', 'modern romance']
  },
  { 
    username: '@Lush_Lina', 
    style: 'bold colors and lush silhouettes', 
    userId: 'bot-lush_lina',
    expertise: 'bold color combinations, lush fabrics, and dramatic styling',
    personality: 'bold, artistic, loves dramatic fashion statements',
    specialties: ['bold colors', 'dramatic silhouettes', 'artistic styling', 'lush fabrics']
  },
  { 
    username: '@LuxeLane_Official', 
    style: 'sophisticated brand voice', 
    userId: 'bot-luxelane_official',
    expertise: 'brand fashion, trend forecasting, and industry insights',
    personality: 'professional, knowledgeable, loves sharing fashion industry insights',
    specialties: ['trend forecasting', 'brand collaborations', 'industry insights', 'fashion business']
  },
  { 
    username: '@Miyabi_K', 
    style: 'Japanese street style and Asian fashion trends', 
    userId: 'bot-miyabi_k',
    expertise: 'Japanese street style, Asian fashion trends, and modern minimalism',
    personality: 'trendy, minimalist, loves Japanese and Korean fashion influences',
    specialties: ['Japanese street style', 'Korean fashion', 'minimalist aesthetics', 'Asian fashion trends']
  },
];

// Fashion topics and responses for more engaging conversations
const fashionTopics = {
  trends: [
    'What trends are you loving this season?',
    'Have you tried the new [trend] look?',
    'I\'m obsessed with [trend] right now!',
    'What do you think about [trend]?'
  ],
  styling: [
    'How do you style [item]?',
    'What would you pair with [item]?',
    'I need help styling [item] for [occasion]',
    'What\'s your go-to styling trick?'
  ],
  shopping: [
    'Where do you shop for [category]?',
    'What\'s your favorite [category] brand?',
    'I\'m looking for [item] recommendations',
    'What\'s worth investing in right now?'
  ],
  occasions: [
    'What should I wear to [occasion]?',
    'I have a [occasion] coming up, any ideas?',
    'What\'s your favorite [occasion] look?',
    'Help me plan an outfit for [occasion]'
  ]
};

export function initBots(chatNamespace, { appendAndEmitMessage, botUsers } = {}) {
  chatNamespace.on('connection', (socket) => {
    socket.on('send_message', async (messageData) => {
      try {
        const userText = typeof messageData?.text === 'string' ? messageData.text.trim() : '';
        if (!userText) return;

        const allowedRooms = new Set(['fashion', 'style', 'outfits', 'trending-fashion', 'general']);
        const roomName = typeof messageData?.room === 'string' ? messageData.room : undefined;
        const toUserId = messageData?.toUserId ? String(messageData.toUserId) : undefined;
        const isDmToBot = !!toUserId && Array.isArray(botUsers) && botUsers.some(b => b.userId === toUserId);
        
        // Only respond in fashion-related rooms or direct messages to bots
        if (!isDmToBot && (!roomName || !allowedRooms.has(roomName))) return;

        // For DMs, use the specific bot being messaged
        let bot;
        if (isDmToBot) {
          const targetBot = botUsers.find(b => b.userId === toUserId);
          bot = fashionBots.find(b => b.userId === targetBot?.userId);
        } else {
          // For room messages, randomly select a bot
          bot = fashionBots[Math.floor(Math.random() * fashionBots.length)];
        }

        if (!bot) return;

        const aiReply = await getAIResponse(bot, userText, isDmToBot);

        if (typeof appendAndEmitMessage === 'function') {
          appendAndEmitMessage({
            sender: bot.username,
            userId: bot.userId,
            text: aiReply,
            room: messageData.room,
            toUserId: messageData.toUserId,
            file: undefined,
            readBy: [],
            reactions: {},
          });
        } else {
          const replyMessage = {
            id: `bot-${Date.now()}`,
            sender: bot.username,
            userId: bot.userId || 'bot',
            text: aiReply,
            room: messageData.room,
            toUserId: messageData.toUserId,
            timestamp: new Date().toISOString(),
            isBot: true,
            readBy: [],
            reactions: {},
          };
          if (messageData.toUserId) {
            chatNamespace.emit('receive_message', replyMessage);
          } else if (messageData.room) {
            chatNamespace.to(String(messageData.room)).emit('receive_message', replyMessage);
          } else {
            chatNamespace.emit('receive_message', replyMessage);
          }
        }
      } catch {
        // ignore
      }
    });
  });

  // Enhanced periodic fashion tips with more variety
  setInterval(() => {
    const bot = fashionBots[Math.floor(Math.random() * fashionBots.length)];
    const tips = [
      `âœ¨ ${bot.username.replace('@', '')} here! Style tip: Mix textures for a bold look!`,
      `ðŸŒ¸ Today's color inspiration: Lavender & gold. Perfect for ${bot.style} vibes!`,
      `ðŸ‘œ Statement bags are IN this week. ${bot.username.replace('@', '')} approves!`,
      `ðŸ‘  Never underestimate the power of great shoes. ${bot.username.replace('@', '')} says so!`,
      `ðŸ’« ${bot.username.replace('@', '')} loves ${bot.specialties[0]} - it's a game changer!`,
      `ðŸŒŸ Pro tip from ${bot.username.replace('@', '')}: Confidence is your best accessory!`,
      `ðŸŽ¨ ${bot.username.replace('@', '')} says: Don't be afraid to experiment with ${bot.specialties[1]}!`,
      `ðŸ’Ž ${bot.username.replace('@', '')} believes in ${bot.specialties[2]} for that perfect look!`,
    ];

    const text = tips[Math.floor(Math.random() * tips.length)];
    if (typeof appendAndEmitMessage === 'function') {
      appendAndEmitMessage({
        sender: bot.username,
        userId: bot.userId,
        text,
        room: 'fashion',
        toUserId: undefined,
        file: undefined,
        readBy: [],
        reactions: {},
      });
    } else {
      const tipMessage = {
        id: `bot-${Date.now()}`,
        sender: bot.username,
        userId: bot.userId || 'bot',
        text,
        room: 'fashion',
        timestamp: new Date().toISOString(),
        isBot: true,
        readBy: [],
        reactions: {},
      };
      chatNamespace.to('fashion').emit('receive_message', tipMessage);
    }
  }, 180000); // Every 3 minutes
}

async function getAIResponse(bot, userMessage, isDm = false) {
  const botName = bot.username.replace('@', '');
  const style = bot.style;
  const expertise = bot.expertise;
  const personality = bot.personality;
  const specialties = bot.specialties.join(', ');

  const systemPrompt = `You are ${botName}, a fashion influencer with a ${style} style. 
  
Your expertise: ${expertise}
Your personality: ${personality}
Your specialties: ${specialties}

${isDm ? 'This is a direct message conversation. Be more personal and engaging.' : 'This is a group chat. Keep responses concise but helpful.'}

Respond in a way that reflects your unique personality and fashion expertise. Use emojis occasionally, be encouraging, and share your fashion knowledge naturally. Keep responses under 150 words unless the user asks for detailed advice.`;

  const userPrompt = `User message: "${userMessage}"`;

  if (typeof fetch !== 'function') {
    return `Hi! I'm ${botName} ðŸ’« As someone who loves ${bot.specialties[0]}, I'd say confidence is your best accessory! What's your style vibe?`;
  }

  try {
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt }
        ],
        max_tokens: 200,
        temperature: 0.8,
      }),
    });

    if (!res.ok) throw new Error(`OpenAI API error: ${res.status}`);
    const data = await res.json();
    return (data?.choices?.[0]?.message?.content || '').trim() ||
      `Hi! I'm ${botName} ðŸ’« As someone who loves ${bot.specialties[0]}, I'd say confidence is your best accessory! What's your style vibe?`;
  } catch {
    return `Hi! I'm ${botName} ðŸ’« As someone who loves ${bot.specialties[0]}, I'd say confidence is your best accessory! What's your style vibe?`;
  }
}

export default { initBots };


